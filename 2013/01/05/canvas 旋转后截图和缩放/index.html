<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> canvas 旋转后截图和缩放 · Perpetual motion</title><meta name="description" content="canvas 旋转后截图和缩放 - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Perpetual motion"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">canvas 旋转后截图和缩放</h1><div class="post-info">Jan 5, 2013</div><div class="post-content"><p>上次说了，当一个图片旋转的时候，画布必须为一个正方形，这样旋转的时候，图片就不会被截取掉。但是这样的话就造成了另一个问题，就是画布中有空白的区域。这篇文章，我们就来解决空白区域的问题。</p>
<p>首先介绍一个函数：getImageData(x,y,w,h)得到画布特定区域的图片信息。参数 分别指的是画布起始点的x轴和y轴，区域的高度和宽度。</p>
<p> 另一个函数：putImageData(imageData,x,y,dx,dx,dw,dh) 将得到的图像数据放入画布中。</p>
<p> 当图片（长方形）旋转的时候的，图片在画布中的位置是变化的。</p>
<p>正常： 90度：180度： 270度：</p>
<p>刚才是宽度大于高度的情况，下面是宽度小于高度的情况。</p>
<p>正常： 90度： 180度： 270度：</p>
<p>看上面的把张图片，我们可以看出图片不一样的，需要截取的位置就不一样。一般来说就有两种情况：宽度大于高度，宽度小于高度。我们要根据特定的情况，来获得位置。</p>
<p>得到数据以后，后面的工作就简单了。</p>
<p>不过还有一种情况，是必须要考虑的，就是图片的尺寸大于屏幕的尺寸。这种情况下，我们就必须把图片进行一些缩放。缩放时候，我们用到了drawImage这个函数。我们首先来看看这个函数。drawImage(image,sx,sh,sw,sh,dx,dy,dh,dw)。</p>
<p>当dh、dw大于sh、sw，那么图片就会被缩小，反之就会被放大。<br><a id="more"></a><br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>图片旋转<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span><span class="undefined">  </span></div><div class="line">    canvas,img&#123;  </div><div class="line">        border:1px solid #F00;  </div><div class="line">    &#125;  </div><div class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </div><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"rotate"</span> <span class="attr">value</span>=<span class="string">"旋转"</span> <span class="attr">onclick</span>=<span class="string">"ratateImage()"</span>/&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"tranforms"</span> <span class="attr">value</span>=<span class="string">"转换"</span>/&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"myCanvas"</span> <span class="attr">width</span>=<span class="string">"117"</span> <span class="attr">height</span>=<span class="string">"117"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"#"</span> <span class="attr">id</span>=<span class="string">"show"</span> /&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> &gt;</span><span class="javascript">  </span></div><div class="line"><span class="keyword">var</span> rotate=<span class="number">0</span>;  </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ratateImage</span>(<span class="params"></span>)</span>&#123;       </div><div class="line">    <span class="keyword">var</span> c=<span class="built_in">document</span>.getElementById(<span class="string">"myCanvas"</span>);  </div><div class="line">    <span class="keyword">var</span> img=<span class="keyword">new</span> Image();  </div><div class="line">    img.src=<span class="string">"test2.PNG"</span>;  </div><div class="line">    img.onload=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  </div><div class="line">        <span class="keyword">var</span> zoomNum=<span class="number">1</span>;  </div><div class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.width&gt;<span class="number">117</span>)&#123;  </div><div class="line">            <span class="keyword">var</span> zoomNum=<span class="number">117</span>/<span class="keyword">this</span>.width;  </div><div class="line">        &#125;  </div><div class="line">        <span class="keyword">var</span> sizeNum=<span class="keyword">this</span>.height&gt;<span class="keyword">this</span>.width?<span class="keyword">this</span>.height:<span class="keyword">this</span>.width;  </div><div class="line">        sizeNum=sizeNum*zoomNum;      </div><div class="line">        <span class="keyword">var</span> centerNum=<span class="built_in">Math</span>.ceil(sizeNum/<span class="number">2</span>);      </div><div class="line">        c.setAttribute(<span class="string">"width"</span>,sizeNum);  </div><div class="line">        c.setAttribute(<span class="string">"height"</span>,sizeNum);     </div><div class="line">        <span class="keyword">var</span> cxt=c.getContext(<span class="string">"2d"</span>);  </div><div class="line">        cxt.translate(centerNum,centerNum);       </div><div class="line">        cxt.rotate(getRotateNum());           </div><div class="line">        cxt.drawImage(img,<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.width,<span class="keyword">this</span>.height,-centerNum,-centerNum,<span class="keyword">this</span>.width*zoomNum,<span class="keyword">this</span>.height*zoomNum);  </div><div class="line">        getPosition(<span class="keyword">this</span>);  </div><div class="line">    &#125;  </div><div class="line">    rotate+=<span class="number">90</span>;  </div><div class="line">    <span class="keyword">if</span>(rotate==<span class="number">360</span>)&#123;  </div><div class="line">        rotate=<span class="number">0</span>;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getRotateNum</span>(<span class="params"></span>)</span>&#123;          </div><div class="line">    <span class="keyword">var</span> rotate=<span class="keyword">this</span>.rotate;  </div><div class="line">    <span class="keyword">var</span> reg=<span class="built_in">Math</span>.PI/<span class="number">2</span>;  </div><div class="line">    <span class="keyword">switch</span>(rotate)&#123;  </div><div class="line">        <span class="keyword">case</span> <span class="number">90</span>:reg=reg;  </div><div class="line">        <span class="keyword">break</span>;  </div><div class="line">        <span class="keyword">case</span> <span class="number">180</span>:reg=reg*<span class="number">2</span>;  </div><div class="line">        <span class="keyword">break</span>;  </div><div class="line">        <span class="keyword">case</span> <span class="number">270</span>:reg=reg*<span class="number">3</span>;  </div><div class="line">        <span class="keyword">break</span>;              </div><div class="line">    &#125;          </div><div class="line">    <span class="keyword">return</span> reg;                  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">imgObj</span>)</span>&#123;  </div><div class="line">    <span class="keyword">var</span> zoomNum=<span class="number">117</span>/imgObj.width;      </div><div class="line">    <span class="keyword">var</span> sizeNum=imgObj.height&gt;imgObj.width?imgObj.height:imgObj.width;          </div><div class="line">    <span class="keyword">if</span>(imgObj.width&lt;imgObj.height)&#123;  </div><div class="line">        <span class="keyword">if</span>(rotate==<span class="number">90</span>)&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.height*zoomNum;  </div><div class="line">            _h=imgObj.width*zoomNum;          </div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rotate==<span class="number">180</span>)&#123;  </div><div class="line">            _x=sizeNum-imgObj.width*zoomNum;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.width*zoomNum;  </div><div class="line">            _h=imgObj.height*zoomNum;  </div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rotate==<span class="number">270</span>)&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=sizeNum-imgObj.width*zoomNum;  </div><div class="line">            _w=imgObj.height*zoomNum;  </div><div class="line">            _h=imgObj.width*zoomNum;  </div><div class="line">        &#125;<span class="keyword">else</span>&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.width*zoomNum;  </div><div class="line">            _h=imgObj.height*zoomNum;  </div><div class="line">        &#125;         </div><div class="line">    &#125;<span class="keyword">else</span>&#123;        </div><div class="line">        <span class="keyword">if</span>(rotate==<span class="number">90</span>)&#123;  </div><div class="line">            _x=sizeNum-imgObj.height*zoomNum;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.height*zoomNum;  </div><div class="line">            _h=imgObj.width*zoomNum;          </div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rotate==<span class="number">180</span>)&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=sizeNum-imgObj.height*zoomNum;  </div><div class="line">            _w=imgObj.width*zoomNum;  </div><div class="line">            _h=imgObj.height*zoomNum;  </div><div class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(rotate==<span class="number">270</span>)&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.height*zoomNum;  </div><div class="line">            _h=imgObj.width*zoomNum;  </div><div class="line">        &#125;<span class="keyword">else</span>&#123;  </div><div class="line">            _x=<span class="number">0</span>;  </div><div class="line">            _y=<span class="number">0</span>;  </div><div class="line">            _w=imgObj.width*zoomNum;  </div><div class="line">            _h=imgObj.height*zoomNum;  </div><div class="line">        &#125;     </div><div class="line">    &#125;  </div><div class="line">    posObj=&#123;  </div><div class="line">            <span class="attr">x</span>:<span class="built_in">Math</span>.floor(_x),  </div><div class="line">            <span class="attr">y</span>:<span class="built_in">Math</span>.floor(_y),  </div><div class="line">            <span class="attr">w</span>:<span class="built_in">Math</span>.floor(_w),  </div><div class="line">            <span class="attr">h</span>:<span class="built_in">Math</span>.floor(_h)  </div><div class="line">    &#125;;  </div><div class="line">    <span class="keyword">return</span> posObj;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line">ratateImage();  </div><div class="line">  </div><div class="line"><span class="built_in">document</span>.getElementById(<span class="string">"tranforms"</span>).onclick=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;  </div><div class="line">    <span class="keyword">debugger</span>;  </div><div class="line">    <span class="keyword">var</span> e=<span class="built_in">document</span>.getElementById(<span class="string">"myCanvas"</span>);  </div><div class="line">    cxt=e.getContext(<span class="string">"2d"</span>);   </div><div class="line">    alert(posObj.x+<span class="string">","</span>+posObj.y+<span class="string">","</span>+posObj.w+<span class="string">","</span>+posObj.h);  </div><div class="line">    <span class="keyword">var</span> imageData=cxt.getImageData(posObj.x,posObj.y,posObj.w,posObj.h);  </div><div class="line">    e.setAttribute(<span class="string">"height"</span>,_h);  </div><div class="line">    e.setAttribute(<span class="string">"width"</span>,_w);   </div><div class="line">    cxt.clearRect(_h,_w);              </div><div class="line">    cxt.putImageData(imageData,<span class="number">0</span>,<span class="number">0</span>);  </div><div class="line">    <span class="keyword">var</span> b=e.toDataURL();  </div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"show"</span>).src=b;  </div><div class="line">&#125;  </div><div class="line">  </div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
</div></article></div></main><footer><div class="paginator"><a href="/2013/01/05/图片展示应用中内存不断升高的问题/" class="prev">PREV</a><a href="/2013/01/05/固定高度div底部显示问题/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>