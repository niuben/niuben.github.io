<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Webpack CommonChunkPlugin详解 · Perpetual motion</title><meta name="description" content="Webpack CommonChunkPlugin详解 - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Perpetual motion"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Webpack CommonChunkPlugin详解</h1><div class="post-info">Jul 13, 2016</div><div class="post-content"><h2 id="webpack介绍"><a href="#webpack介绍" class="headerlink" title="webpack介绍"></a>webpack介绍</h2><p>Webpack最近比较流行前端构建工具.它通过分析代码中require调用方式，将代码进行模块化打包，相关多个JS文件会打包成一个文件。同时Webpack还具有MD5版本、内置开发调试服务器等功能；相比Grunt和Gulp等任务流构建工具，Webpack具有模块化打包能力。</p>
<p>CommonChunkPlugin插件是Webpack官方插件，用于公共文件提取打包；将多个模块都调用到文件，打包到一个公共Chunk中；避免多个模块重复打包相同文件，大大降低整体文件大小；</p>
<h2 id="CommonChunkPlugin参数列表"><a href="#CommonChunkPlugin参数列表" class="headerlink" title="CommonChunkPlugin参数列表"></a>CommonChunkPlugin参数列表</h2><ul>
<li>name: 公共包名称叫什么。如果存在包名和name相同的话，这个包会变成公共包；如果name是数组会调用数组中每个名字；每个名字都可能是公共文件；如果这个参数没有赋值，所有包都会被选中；</li>
<li>filename: 公共包文件格式；</li>
<li>minChunks: 一个包放入公共包需要的最小次数；</li>
<li>chunks: 那些包会被选中，如果这个值忽略，所有entry包都会被选中；</li>
<li>children: 如果为true，公共包子元素都会被选中；</li>
<li>async: 如果为true，会创建一个async公共包，会和其他包共同加载；</li>
<li>minsize: 可以打包的最小质量；比如100KB；</li>
</ul>
<h2 id="CommonChunkPlugin实现原理"><a href="#CommonChunkPlugin实现原理" class="headerlink" title="CommonChunkPlugin实现原理"></a>CommonChunkPlugin实现原理</h2><h4 id="调试Webpack"><a href="#调试Webpack" class="headerlink" title="调试Webpack"></a>调试Webpack</h4><p>前端需要使用工具来调试，方便知道程序中变量的值和逻辑运行情况；node-inspector是专门调试node程序；使用之前需要将node版本升级，如果版本过低，有些功能无法使用；按照使用如下：</p>
<ul>
<li>npm install node-inspector -g</li>
<li>npm-inspector</li>
<li>进入项目文件夹，找到webpack.config.js文件；</li>
<li>node –debug-brk node_modules/webpack/bin/webpack.js(webpack所在文件夹）</li>
<li>打开chrome浏览器，输入<a href="http://127.0.0.1:8080/?ws=127.0.0.1:8080&amp;port=5858；" target="_blank" rel="external">http://127.0.0.1:8080/?ws=127.0.0.1:8080&amp;port=5858；</a></li>
</ul>
<a id="more"></a>
<h4 id="公共文件数据结构"><a href="#公共文件数据结构" class="headerlink" title="公共文件数据结构"></a>公共文件数据结构</h4><p>有三个数据类型需要理解：block、module、chunk；</p>
<ul>
<li>block：</li>
<li>module：一个commonJS或者AMD文件；</li>
<li>chunk：多个module打包生成的；</li>
</ul>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!chunkNames &amp;&amp; (selectedChunks === <span class="literal">false</span> || <span class="keyword">async</span>)) &#123;</div><div class="line">   commonChunks = chunks;</div><div class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(chunkNames)) &#123;</div><div class="line">    commonChunks = chunkNames.map(<span class="function"><span class="keyword">function</span>(<span class="params">chunkName</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> chunks.filter(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> chunk.name === chunkName;</div><div class="line">    &#125;)[<span class="number">0</span>];</div><div class="line"> &#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    commonChunks = chunks.filter(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> chunk.name === chunkNames;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="通过配置中name属性，将commonChunks进行赋值；"><a href="#通过配置中name属性，将commonChunks进行赋值；" class="headerlink" title="通过配置中name属性，将commonChunks进行赋值；"></a>通过配置中name属性，将commonChunks进行赋值；</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(<span class="built_in">Array</span>.isArray(selectedChunks)) &#123;</div><div class="line">    usedChunks = chunks.filter(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(chunk === commonChunk) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">return</span> selectedChunks.indexOf(chunk.name) &gt;= <span class="number">0</span>;</div><div class="line">    &#125;);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span>(selectedChunks === <span class="literal">false</span> || <span class="keyword">async</span>) &#123;</div><div class="line">    usedChunks = (commonChunk.chunks || []).filter(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;           </div><div class="line">       <span class="keyword">return</span> <span class="keyword">async</span> || chunk.parents.length === <span class="number">1</span>;</div><div class="line">    &#125;);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">if</span>(!commonChunk.entry) &#123;</div><div class="line">        compilation.errors.push(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"CommonsChunkPlugin: While running in normal mode it's not allowed to use a non-entry chunk ("</span> + commonChunk.name + <span class="string">")"</span>));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    usedChunks = chunks.filter(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> found = commonChunks.indexOf(chunk);</div><div class="line">        <span class="keyword">if</span>(found &gt;= idx) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        <span class="keyword">return</span> chunk.entry;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="获得被使用的包"><a href="#获得被使用的包" class="headerlink" title="获得被使用的包"></a>获得被使用的包</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">usedChunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">    chunk.modules.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> idx = commonModules.indexOf(<span class="built_in">module</span>);</div><div class="line">        <span class="keyword">if</span>(idx 小于 <span class="number">0</span>)&#123;</div><div class="line">            commonModules.push(<span class="built_in">module</span>);</div><div class="line">            commonModulesCount.push(<span class="number">1</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            commonModulesCount[idx]++;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h4 id="使用包中每个模块被调用的个数；"><a href="#使用包中每个模块被调用的个数；" class="headerlink" title="使用包中每个模块被调用的个数；"></a>使用包中每个模块被调用的个数；</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">commonModulesCount.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">count, idx</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> <span class="built_in">module</span> = commonModules[idx];</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> minChunks === <span class="string">"function"</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(!minChunks(<span class="built_in">module</span>, count))</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(count 小于 (minChunks || <span class="built_in">Math</span>.max(<span class="number">2</span>, usedChunks.length))) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    reallyUsedModules.push(<span class="built_in">module</span>);</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<!-- more -->
<h4 id="将大于minChunks的module存入到reallyUsedModules中；"><a href="#将大于minChunks的module存入到reallyUsedModules中；" class="headerlink" title="将大于minChunks的module存入到reallyUsedModules中；"></a>将大于minChunks的module存入到reallyUsedModules中；</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">reallyUsedModules.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">module</span>) </span>&#123;</div><div class="line">    usedChunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(<span class="built_in">module</span>.removeChunk(chunk)) &#123;</div><div class="line">            <span class="keyword">if</span>(reallyUsedChunks.indexOf(chunk) 小于 <span class="number">0</span>)</div><div class="line">               reallyUsedChunks.push(chunk);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        commonChunk.addModule(<span class="built_in">module</span>);</div><div class="line">        <span class="built_in">module</span>.addChunk(commonChunk);</div><div class="line">   &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="将多次调佣module存入CommonChunk中；"><a href="#将多次调佣module存入CommonChunk中；" class="headerlink" title="将多次调佣module存入CommonChunk中；"></a>将多次调佣module存入CommonChunk中；</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">reallyUsedChunks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(chunk.initial || chunk.entry)</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    chunk.blocks.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">block</span>) </span>&#123;</div><div class="line">        block.chunks.unshift(commonChunk);</div><div class="line">        commonChunk.addBlock(block);</div><div class="line">    &#125;);</div><div class="line">&#125;);</div><div class="line">asyncChunk.origins = reallyUsedChunks.map(<span class="function"><span class="keyword">function</span>(<span class="params">chunk</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> chunk.origins.map(<span class="function"><span class="keyword">function</span>(<span class="params">origin</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> newOrigin = <span class="built_in">Object</span>.create(origin);</div><div class="line">        newOrigin.reasons = (origin.reasons || []).slice();</div><div class="line">        newOrigin.reasons.push(<span class="string">"async commons"</span>);</div><div class="line">        <span class="keyword">return</span> newOrigin;</div><div class="line">    &#125;);</div><div class="line">&#125;).reduce(<span class="function"><span class="keyword">function</span>(<span class="params">arr, a</span>) </span>&#123;</div><div class="line">    arr.push.apply(arr, a);</div><div class="line">    <span class="keyword">return</span> arr;</div><div class="line">&#125;, []);</div></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2016/12/25/webpack打包速度优化之DllPlugin/" class="prev">PREV</a><a href="/2016/05/03/webpack dev server 调试服务器介绍/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>