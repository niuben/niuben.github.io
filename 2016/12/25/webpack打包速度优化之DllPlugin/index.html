<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> webpack打包速度优化之DllPlugin · Perpetual motion</title><meta name="description" content="webpack打包速度优化之DllPlugin - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Perpetual motion"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">webpack打包速度优化之DllPlugin</h1><div class="post-info">Dec 25, 2016</div><div class="post-content"><h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><p>　随着web应用化和复杂化，前端开发越来越多依赖第三方文件，比如React、Bootstrap、Moment等。前端加载资源文件数量也极具上升。举个例子，如果你只想用React在页面写个”Hello World”，也要引用大约160个文件(React加上ReactDOM)。一般应用还用一些类似Bootstrap等 UI框架，这样的话相关依赖资源很快都能到达一百多个。例如我目前开发一个后台系统：前端框架用是React，UI库是公司的Ant，光两个依赖的资源数已经达到160多个了。</p>
<p>　这种技术选型在开发中产生一个问题：打包速度慢。做了一个时间测试，用React和Ant新建一个空项目。在没有业务逻辑前提下，通过watch监听文件变化，从文件保存、开始打包到打包结束，整个过程已经耗时大约1.5秒。当业务逻辑不断增加和更多第三方库被引入进来，这个“1.5秒”时间肯定会变大。</p>
<p>　打包速度慢直接影响到开发效率。当只改了一处文案需要等待几秒钟才能在浏览器看到效果，这个开发体验肯定会人难以忍受。项目上线所需时间也会因为打包速度慢而变得更长。分析上面情况后会发现webpack打包速度慢，最主要的原因是第三方文件本身依赖文件太多。时间都消耗在处理第三方文件自身依赖关系上，而业务文件消耗的时间其实很短。想个办法去改进一下。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>　<strong>可以将第三方文件单独打包。</strong>因为第三方文件基本不会改变，所以只需要打包一次。只有在第三方文件发生改变的情况下，比如删除或者增加一个文件，才需要重新进行打包。这里打包生成的文件有点像一个lib库文件，只是它由很多第三方库文件组成。最后将打包生成的文件通过 script 标签、Commonjs、AMD等方式引用进来。script标签引入代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;./dist/lib.bundle.js&quot;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<p>　解决第三方文件后，开发过程中只需要打包业务文件。通常业务文件不会像第三方库有那么多依赖关系，引用也相对简单，所以当只打包业务文件的时候，速度会有大大提升。还是用上面”Hello world”为例，我们先把React和Antd单独打包成”lib.bundle.js”,然后用script标签方式引用；然后只打包业务文件。</p>
<p>　结果：发现整个打包过程仅用时<strong>”50毫秒“</strong>提高<strong>30倍</strong>速度。打包时间大大的缩短。</p>
<h2 id="插件介绍"><a href="#插件介绍" class="headerlink" title="插件介绍"></a>插件介绍</h2><p>整个过程需要用到Webpack两个插件。</p>
<h4 id="DllPlugin和DllReferencePlugin。"><a href="#DllPlugin和DllReferencePlugin。" class="headerlink" title="DllPlugin和DllReferencePlugin。"></a>DllPlugin和DllReferencePlugin。</h4><ul>
<li>DllPlugin: 将指定文件和它们所依赖文件生成一张文件id和文件路径映射表。文件id是从入口文件开始按文件被引用顺序生成的。</li>
<li>DllReferencePlugin: 根据DllPlugin生成映射表，业务文件会找到引用第三方文件id。直接引入文件id号。</li>
</ul>
<p>　打包速度加快原因是业务文件文件只引用文件ID，不用引用文件内容。这样就不会将第三库文件内容加载到业务文件bundle中，最后生成体积也大大减小。但是整体文件体积没有减小，不过因为第三方文件不会经常改变，所以可以缓存在用户浏览器中。对经常用产品的用户打开页面速度也会大大加快。</p>
<p>　这两个插件使用是有先后顺序，必须先使用DllPlugin然后才能使用DllReferencePlugin。当DllPlugin已经生成映射表(manifes.json)，以后就可以直接使用DllReferencePlugin。只有当需要更新库文件才使用DllPlugin。</p>
<h4 id="DllPlugin参数"><a href="#DllPlugin参数" class="headerlink" title="DllPlugin参数"></a>DllPlugin参数</h4><ul>
<li>path: 映射表生成路径；</li>
<li>name: bundle文件引用变量名；<br>&lt;&lt;&lt;&lt;&lt;&lt;&lt; Updated upstream</li>
<li>context: 设置请求上下文， 默认为webpack.config.js所在路径。</li>
</ul>
<h4 id="DllReferencePlugin参数"><a href="#DllReferencePlugin参数" class="headerlink" title="DllReferencePlugin参数"></a>DllReferencePlugin参数</h4><ul>
<li>context: 设置映射表里请求的上下文；</li>
<li>scope: 给引用文件增加前缀；</li>
<li>manifest: 引用一个DllPlugin生成映射表;</li>
<li>name: 映射表对应bundle的变量名；</li>
<li><h1 id="sourceType-规定引用模块的方式：比如var-commonjs-amd等，默认是var；"><a href="#sourceType-规定引用模块的方式：比如var-commonjs-amd等，默认是var；" class="headerlink" title="sourceType: 规定引用模块的方式：比如var,commonjs,amd等，默认是var；"></a>sourceType: 规定引用模块的方式：比如var,commonjs,amd等，默认是var；</h1></li>
<li>context: 设文件相对路径，默认为webpack.config.js所在路径。</li>
</ul>
<h4 id="DllReferencePlugin参数-1"><a href="#DllReferencePlugin参数-1" class="headerlink" title="DllReferencePlugin参数"></a>DllReferencePlugin参数</h4><ul>
<li>context: 设文件相对路径，默认为webpack.config.js所在路径；</li>
<li>scope: </li>
<li>manifest: 引用一个DllPlugin生成映射表；</li>
<li>name: 映射表对应bundle的变量名；</li>
<li>sourceType: 命名变量名方式； <blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>Stashed changes</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</li>
<li>content: 映射表内容，默认是指manifest.content。</li>
</ul>
<h4 id="映射表manifest-json内容如下"><a href="#映射表manifest-json内容如下" class="headerlink" title="映射表manifest.json内容如下"></a>映射表manifest.json内容如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	&quot;name&quot;: &quot;lib&quot;,</div><div class="line">	&quot;content&quot;: &#123;</div><div class="line">	    &quot;../node_modules/react/react.js&quot;: 1,</div><div class="line">	    &quot;../node_modules/react/lib/React.js&quot;: 2,</div><div class="line">	    &quot;../node_modules/react/lib/ReactDOM.js&quot;: 3,</div><div class="line">	    &quot;../node_modules/react/lib/ReactCurrentOwner.js&quot;: 5,</div><div class="line">	    &quot;../node_modules/react/lib/ReactDOMTextComponent.js&quot;: 6,</div><div class="line">	    &quot;../node_modules/react/lib/DOMChildrenOperations.js&quot;: 7,</div><div class="line">	    &quot;../node_modules/react/lib/Danger.js&quot;: 8,</div><div class="line">	    ....</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>name是bundle变量名，content是文件路径和文件ID映射关系。</p>
<h2 id="webpack配置"><a href="#webpack配置" class="headerlink" title="webpack配置"></a>webpack配置</h2><p>需要两个webpack配置文件： webpack.lib.config.js和webpack.config.js。第一个用于打第三方文件，第二个打包业务文件。一般只会用到一次webpack.lib.config.js文件，除非第三方文件发生了改变。</p>
<h4 id="webpack-lib-config-js配置"><a href="#webpack-lib-config-js配置" class="headerlink" title="webpack.lib.config.js配置"></a>webpack.lib.config.js配置</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</div><div class="line"><span class="keyword">var</span> config = &#123;</div><div class="line">    <span class="attr">entry</span>: &#123;</div><div class="line">        <span class="attr">lib</span>:[            </div><div class="line">            <span class="string">"react"</span>, </div><div class="line">            <span class="string">"react-dom"</span>,             </div><div class="line">            <span class="string">"antd"</span>,             </div><div class="line">        ],</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">output</span>: &#123;</div><div class="line">        <span class="attr">path</span>: path.join(__dirname) + <span class="string">"/dist/"</span>,        </div><div class="line">        <span class="attr">filename</span>: <span class="string">"[name].bundle.js"</span>,</div><div class="line">        <span class="attr">library</span>: <span class="string">"[name]"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">plugins</span>: [    </div><div class="line">        <span class="keyword">new</span> webpack.DllPlugin(&#123;</div><div class="line">            <span class="attr">path</span>: path.join(__dirname, <span class="string">"dist"</span>, <span class="string">"[name].manifest.json"</span>),</div><div class="line">            <span class="attr">name</span>: <span class="string">"[name]"</span>,</div><div class="line">            <span class="attr">context</span>: <span class="string">"./dist/"</span></div><div class="line">        &#125;)</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = config;</div></pre></td></tr></table></figure>
<p>启动第三方文件打包命令:  <figure class="highlight plain"><figcaption><span>--config webpack.lib.config.js```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#### webpack.config.js配置</div><div class="line">```js</div><div class="line">var path = require(&quot;path&quot;);</div><div class="line">var webpack = require(&quot;webpack&quot;);</div><div class="line"></div><div class="line">var config = &#123;</div><div class="line">    entry: &#123;        </div><div class="line">        app: [&apos;./index&apos;]</div><div class="line">    &#125;,</div><div class="line">    output: &#123;</div><div class="line">        path: path.join(__dirname) + &quot;/dist/&quot;,</div><div class="line">        filename: &quot;[name].bundle.js&quot;</div><div class="line">    &#125;,</div><div class="line">    module: &#123;</div><div class="line">        loaders: [&#123;</div><div class="line">            test: /\.(js)$/,</div><div class="line">            exclude: /node_modules/,</div><div class="line">            loader: &apos;babel-loader&apos;,</div><div class="line">            query: &#123;</div><div class="line">                presets: [&apos;react&apos;, &apos;es2015&apos;]             </div><div class="line">            &#125;</div><div class="line">        &#125;]</div><div class="line">    &#125;,</div><div class="line">    plugins: [</div><div class="line">        new webpack.DllReferencePlugin(&#123;</div><div class="line">            context: &quot;.&quot;,</div><div class="line">            manifest: require(&quot;./dist/lib.manifest.json&quot;),          </div><div class="line">        &#125;)</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">module.exports = config;</div></pre></td></tr></table></figure></p>
<p>启动业务文件打包命令: <code>webpack</code></p>
<h2 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h2><p>　这种分开打包方式特别适合这种场景：第三方文件体积很大内部依赖资源很多，同时修改频率很低。一些SPA应用业务复杂，需要引入很多第三方文件进行开发。可以考虑这种分开打包的方案。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/01/13/Debug工具项目复盘/" class="prev">PREV</a><a href="/2016/07/13/Webpack CommonChunkPlugin详解/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>