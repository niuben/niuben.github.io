<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> webpack 防止入口HTML中静态资源缓存 · Perpetual motion</title><meta name="description" content="webpack 防止入口HTML中静态资源缓存 - null"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Perpetual motion"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">webpack 防止入口HTML中静态资源缓存</h1><div class="post-info">Feb 19, 2017</div><div class="post-content"><p>webpack对bundle文件有很好的<code>md5</code>支持，可以通过<code>hash</code>和<code>chunkhash</code>来实现，但对于入口<code>main.html</code>中的静态资源md5没有默认的支持，需要配置相关插件来实现。</p>
<p>关于入口HTML中静态资源有三个问题需要解决</p>
<ul>
<li>怎么让入口HTML动态引入<code>md5</code>的bundle文件；</li>
<li>入口HTML文件中静态资源怎么防止缓存，例如：link引入reset.css情况</li>
<li>如果入口HTML文件是前端模板，怎么支持？</li>
</ul>
<a id="more"></a>
<h3 id="将动态将bundle文件引入到html中"><a href="#将动态将bundle文件引入到html中" class="headerlink" title="将动态将bundle文件引入到html中"></a>将动态将bundle文件引入到html中</h3><p>使用webpack官方插件html-webpack-plugin，可以将打包的bundle文件放入到指定的模板中。<br>参数如下：</p>
<ul>
<li>title: 设置html文件的title</li>
<li>filename: 生成的文件名。默认是index.html，也可以设置路径。如<code>/asset/index</code></li>
<li>template: 模板路径；</li>
<li>inject: true | ‘head’ | ‘body’ | false 是否插入bundle文件，如果值是<code>true</code>或者<code>body</code>会将js bundle文件放在body下面。如果设置为<code>head</code>的话则将bundle文件放在<code>head</code>中。</li>
<li>favicon: 添加<code>favicon</code>路径；</li>
<li>minify: {…} | false 通过传递<code>html-minifier</code>选项来压缩html</li>
<li>hash: true | false 设置为<code>true</code>将文件中包含所有<code>scripts</code>和<code>css</code>文件设置一个<code>hash</code>，这对防止缓存很有用。</li>
<li>cache: true | false 设置为<code>true</code>只有文件发生改变才再次编译。</li>
<li>showErrors: true | false 默认为<code>true</code>，会将错误信息写到页面中。</li>
<li>chunks: 允许你添加指定的<code>chunks</code>。</li>
<li>chunksSortMode: ‘none’ | ‘auto’ | ‘dependency’ | * {function} 默认值是<code>auto</code> 控制<code>chunks</code>的顺序；</li>
<li>excludeChunks: 制定排除一些<code>chunks</code></li>
<li>xhtml: true | false If true render the link tags as self-closing, XHTML compliant. Default is false</li>
</ul>
<p>使用下面配置<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//webpack.config.js</span></div><div class="line">....</div><div class="line">plugin: [</div><div class="line">    <span class="keyword">new</span> htmlwebpackplugin(&#123;</div><div class="line">        <span class="attr">filename</span>: <span class="string">"./app.html"</span>,</div><div class="line">        <span class="attr">template</span>: <span class="string">'./app.html'</span></div><div class="line">    &#125;)</div><div class="line">]</div><div class="line">....</div></pre></td></tr></table></figure></p>
<h3 id="对html中静态资源支持"><a href="#对html中静态资源支持" class="headerlink" title="对html中静态资源支持"></a>对html中静态资源支持</h3><p>模块文件中可能会有<code>link</code>，例如<code>&lt;link href=&#39;./reset.css&#39; /&gt;</code>。也需要给<code>reset.css</code>文件做缓存处理。<br>可以使用<code>html-string-replace-webpack-plugin</code>插件：可以通过正则匹配的方式将静态资源进行md5. 参数如下：</p>
<ul>
<li><code>enable</code>: <code>true | false</code> 是否开启；</li>
<li><code>pattern</code>：创建替换的规则和如何匹配；</li>
<li><code>patterns[parrern].replacement</code>: 标准的替换函数或者字符串；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> StringHtmlStringReplace(&#123;</div><div class="line">    <span class="attr">enable</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">patterns</span>: [</div><div class="line">        &#123;            </div><div class="line">            <span class="comment">// &lt;link href="build.css"&gt;  =&gt;</span></div><div class="line">            <span class="comment">// &lt;link href="//cdn.baidu.com/static/build.css"&gt; </span></div><div class="line">            match: <span class="regexp">/href=\"([^\"]*)\"/g</span>,</div><div class="line">            <span class="attr">replacement</span>: <span class="function"><span class="keyword">function</span> (<span class="params">match, $<span class="number">1</span></span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">'href="'</span> + $<span class="number">1</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()  + <span class="string">'"'</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">         </div><div class="line">            <span class="comment">// &lt;script src="build.js"&gt;  =&gt;</span></div><div class="line">            <span class="comment">// &lt;script src="//cdn.baidu.com/static/build.js"&gt; </span></div><div class="line">            match: <span class="regexp">/src=\"([^\"]*)\"/g</span>,</div><div class="line">            <span class="attr">replacement</span>: <span class="string">'href="'</span> + <span class="string">'$1"'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</div><div class="line">    ]</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>它会html文件<code>href</code>和<code>src</code>属性进行匹配。</p>
<h3 id="前端模板格式支持"><a href="#前端模板格式支持" class="headerlink" title="前端模板格式支持"></a>前端模板格式支持</h3><p>如果使用前端模板，通过对应的loader和<code>html-webpack-plugin</code>配合使用。<code>loader</code>是对模板的解析成<code>html</code>,<code>html-webpack-plugin</code>再对<code>html</code>进行<code>md5</code>处理。<br>例如对<code>jade</code>模板的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">.....</div><div class="line">&#123;</div><div class="line">  <span class="attr">module</span>: &#123;</div><div class="line">    <span class="attr">loaders</span>: [</div><div class="line">      &#123;</div><div class="line">        <span class="attr">test</span>: <span class="regexp">/\.jade$/</span>,</div><div class="line">        <span class="attr">loader</span>: <span class="string">'jade-loader'</span></div><div class="line">      &#125;,</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">plugins</span>: [</div><div class="line">    <span class="keyword">new</span> HtmlWebpackPlugin(&#123;</div><div class="line">      <span class="attr">template</span>: <span class="string">'src/index.jade'</span></div><div class="line">    &#125;)</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">......</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><code>html-webpack-plugin</code>对html中静态资源处理非常有用。有了这个插件后，就不需要在使用<code>grunt|gulp</code>等工具进行处理。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/03/05/babel基本知识学习/" class="prev">上一篇</a><a href="/2017/02/19/webpack2主要新功能/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2017 <a href="http://yoursite.com"></a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>